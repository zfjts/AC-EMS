{% extends 'base.html' %}

{% block title %}库存优化分析{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 bg-gray-50 min-h-screen">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-gray-900">库存优化分析</h1>
    </div>

    <!-- 分析概览卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fa fa-refresh text-blue-500 mr-2"></i>库存周转率
            </h3>
            <p class="text-3xl font-bold text-blue-600">{{ turnover_rate|round(2) }}次/年</p>
            <p class="text-sm text-gray-600 mt-3 flex items-center">
                {% if turnover_trend|float > 0 %}
                <i class="fa fa-arrow-up text-green-500 mr-1"></i>
                {% else %}
                <i class="fa fa-arrow-down text-red-500 mr-1"></i>
                {% endif %}
                较上月: {{ turnover_trend }}%
            </p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fa fa-money text-green-500 mr-2"></i>资金占用
            </h3>
            <p class="text-3xl font-bold text-green-600">{{ capital_occupy|round(2) }}元</p>
            <p class="text-sm text-gray-600 mt-3 flex items-center">
                {% if capital_trend|float > 0 %}
                <i class="fa fa-arrow-up text-red-500 mr-1"></i>
                {% else %}
                <i class="fa fa-arrow-down text-green-500 mr-1"></i>
                {% endif %}
                较上月: {{ capital_trend }}%
            </p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fa fa-exclamation-triangle text-red-500 mr-2"></i>库存预警数
            </h3>
            <p class="text-3xl font-bold text-red-600">{{ warning_count }}</p>
            <p class="text-sm text-gray-600 mt-3">其中: 低库存{{ low_stock_count }}个, 积压{{ overstock_count }}个</p>
        </div>
    </div>

    <!-- 使用频率分析 -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-10 transition-all duration-300 hover:shadow-xl border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fa fa-bar-chart text-blue-500 mr-2"></i>备件使用频率分析
        </h2>
        <div class="h-80 p-4 bg-gray-50 rounded-lg border border-gray-100">
            <canvas id="usageFrequencyChart"></canvas>
        </div>
    </div>

    <!-- 消耗趋势分析 -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-10 transition-all duration-300 hover:shadow-xl border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fa fa-line-chart text-green-500 mr-2"></i>备件消耗趋势分析
        </h2>
        <div class="mb-6">
            <label for="sparePartSelect" class="block text-sm font-medium text-gray-700 mb-2">选择备件</label>
            <select id="sparePartSelect" class="w-full md:w-1/3 border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                <option value="all">所有备件</option>
                {% for part in spare_parts %}
                <option value="{{ part.id }}">{{ part.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="h-80 p-4 bg-gray-50 rounded-lg border border-gray-100">
            <canvas id="consumptionTrendChart"></canvas>
        </div>
    </div>

    <!-- 库存优化建议 -->
    <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fa fa-lightbulb-o text-yellow-500 mr-2"></i>库存优化建议
        </h2>
        <div class="space-y-5">
            {% for suggestion in optimization_suggestions %}
            <div class="border-l-4 border-{{ suggestion.level }}-500 pl-5 py-3 bg-{{ suggestion.level }}-50 rounded-r-lg shadow-sm transition-all duration-300 hover:shadow-md">
                <h3 class="font-semibold text-gray-900 text-base">{{ suggestion.title }}</h3>
                <p class="text-gray-700 text-sm mt-1">{{ suggestion.content }}</p>
                <p class="text-xs text-gray-500 mt-2">相关备件: {{ suggestion.parts|join(', ') }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script src="/static/chart.umd.min.js"></script>
<script>
    // 使用频率图表
    const usageCtx = document.getElementById('usageFrequencyChart').getContext('2d');
    const usageChart = new Chart(usageCtx, {
        type: 'bar',
        data: {
            labels: {{ usage_labels|tojson }},
            datasets: [{
                label: '使用次数',
                data: {{ usage_data|tojson }},
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#333',
                    bodyColor: '#666',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    padding: 12,
                    boxPadding: 6,
                    usePointStyle: true,
                    callbacks: {
                        label: function(context) {
                            return `使用次数: ${context.raw}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });

    // 消耗趋势图表
    const trendCtx = document.getElementById('consumptionTrendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_labels|tojson }},
            datasets: [{
                label: '消耗数量',
                data: {{ trend_data|tojson }},
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                tension: 0.3,
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#333',
                    bodyColor: '#666',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    padding: 12,
                    boxPadding: 6,
                    usePointStyle: true,
                    callbacks: {
                        label: function(context) {
                            return `消耗数量: ${context.raw}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });

    // 备件选择变化事件
    document.getElementById('sparePartSelect').addEventListener('change', function() {
        // 在实际应用中，这里应该通过AJAX加载选中备件的趋势数据
        // 这里仅做演示
        console.log('切换到备件: ' + this.value);
        // 替换为更友好的提示方式
        const Toast = document.createElement('div');
        Toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-500 opacity-0';
        Toast.textContent = '已切换到: ' + (this.options[this.selectedIndex].text);
        document.body.appendChild(Toast);
        setTimeout(() => Toast.style.opacity = '1', 100);
        setTimeout(() => {
            Toast.style.opacity = '0';
            setTimeout(() => document.body.removeChild(Toast), 500);
        }, 2000);
    });
</script>
{% endblock %}